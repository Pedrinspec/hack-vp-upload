# =============================================================================
# VP-UPLOAD — Docker Compose
# Orquestra: vp-upload app, MySQL 8, Redis 7, Kafka (KRaft)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # VP-Upload Application — Spring Boot 4 + FFmpeg
  # ---------------------------------------------------------------------------
  vp-upload:
    build:
      context: ..
      dockerfile: infra/Dockerfile
    image: vp-upload:latest
    container_name: vp-upload-app
    restart: unless-stopped
    environment:
      # Banco de dados
      DATABASE_URL: ${DATABASE_URL:-jdbc:mysql://mysql:3306/hackvp?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=America/Sao_Paulo}
      DATABASE_USER: ${DATABASE_USER:-vpuser}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-root}

      # Redis
      REDIS_HOST: ${REDIS_HOST:-localhost}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_TIMEOUT: ${REDIS_TIMEOUT:-60000}

      # Kafka
      KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      VIDEO_PROCESSOR_TOPIC: ${VIDEO_PROCESSOR_TOPIC:-video-processor-topic}

      # AWS S3 — obrigatório via .env
      AWS_REGION: ${AWS_REGION:-sa-east-1}
      ACCESS_KEY: ${ACCESS_KEY}
      ACCESS_SECRET: ${ACCESS_SECRET}
      AWS_SESSION_TOKEN: ${AWS_SESSION_TOKEN:-}
      S3_VIDEO_BUCKET: ${S3_VIDEO_BUCKET:-hack-vp-videos}

      # JVM tunning adicional
      JAVA_OPTS: "-Xms512m -Xmx1g"
    ports:
      - "8080:8080"
    networks:
      - vp-network
# =============================================================================
# Rede interna isolada
# =============================================================================
networks:
  vp-network:
    external: true
